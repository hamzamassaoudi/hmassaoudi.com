{"version":3,"sources":["../../../src/plugins/Url/index.js"],"names":["Plugin","require","Translator","h","RequestClient","UrlUI","toArray","module","exports","uppy","opts","id","title","type","icon","defaultLocale","strings","import","enterUrlToImport","failedToFetch","enterCorrectUrl","defaultOptions","locale","translator","i18n","translate","bind","hostname","serverUrl","Error","getMeta","addFile","handleDrop","handleDragOver","handleDragLeave","handlePaste","client","getFileNameFromUrl","url","substring","lastIndexOf","checkIfCorrectURL","protocol","match","addProtocolToURL","protocolRegex","defaultProtocol","test","post","then","res","error","log","info","meta","tagFile","source","name","data","size","isRemote","body","remote","fileId","providerOptions","err","dashboard","getPlugin","hideAllPanels","catch","message","details","e","preventDefault","dataTransfer","items","forEach","item","kind","getAsString","el","classList","add","remove","clipboardData","hasFiles","filter","length","render","state","install","target","mount","addEventListener","uninstall","removeEventListener","unmount"],"mappings":"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","file":"index.js","sourcesContent":["const Plugin = require('../../core/Plugin')\nconst Translator = require('../../core/Translator')\nconst { h } = require('preact')\nconst { RequestClient } = require('../../server')\nconst UrlUI = require('./UrlUI.js')\nconst toArray = require('../../utils/toArray')\n\n/**\n * Url\n *\n */\nmodule.exports = class Url extends Plugin {\n  constructor (uppy, opts) {\n    super(uppy, opts)\n    this.id = this.opts.id || 'Url'\n    this.title = 'Link'\n    this.type = 'acquirer'\n    this.icon = () => <svg aria-hidden=\"true\" class=\"UppyIcon UppyModalTab-icon\" width=\"64\" height=\"64\" viewBox=\"0 0 64 64\">\n      <circle cx=\"32\" cy=\"32\" r=\"31\" />\n      <g fill-rule=\"nonzero\" fill=\"#FFF\">\n        <path d=\"M25.774 47.357a4.077 4.077 0 0 1-5.76 0L16.9 44.24a4.076 4.076 0 0 1 0-5.758l5.12-5.12-1.817-1.818-5.12 5.122a6.651 6.651 0 0 0 0 9.392l3.113 3.116a6.626 6.626 0 0 0 4.699 1.943c1.7 0 3.401-.649 4.697-1.943l10.241-10.243a6.591 6.591 0 0 0 1.947-4.696 6.599 6.599 0 0 0-1.947-4.696l-3.116-3.114-1.817 1.817 3.116 3.114a4.045 4.045 0 0 1 1.194 2.88 4.045 4.045 0 0 1-1.194 2.878L25.774 47.357z\" />\n        <path d=\"M46.216 14.926a6.597 6.597 0 0 0-4.696-1.946h-.001a6.599 6.599 0 0 0-4.696 1.945L26.582 25.167a6.595 6.595 0 0 0-1.947 4.697 6.599 6.599 0 0 0 1.946 4.698l3.114 3.114 1.818-1.816-3.114-3.114a4.05 4.05 0 0 1-1.194-2.882c0-1.086.424-2.108 1.194-2.878L38.64 16.744a4.042 4.042 0 0 1 2.88-1.194c1.089 0 2.11.425 2.88 1.194l3.114 3.114a4.076 4.076 0 0 1 0 5.758l-5.12 5.12 1.818 1.817 5.12-5.122a6.649 6.649 0 0 0 0-9.393l-3.113-3.114-.003.002z\" />\n      </g>\n    </svg>\n\n    // Set default options and locale\n    const defaultLocale = {\n      strings: {\n        import: 'Import',\n        enterUrlToImport: 'Enter URL to import a file',\n        failedToFetch: 'Uppy Server failed to fetch this URL, please make sure itâ€™s correct',\n        enterCorrectUrl: 'Incorrect URL: Please make sure you are entering a direct link to a file'\n      }\n    }\n\n    const defaultOptions = {\n      locale: defaultLocale\n    }\n\n    this.opts = Object.assign({}, defaultOptions, opts)\n\n    this.locale = Object.assign({}, defaultLocale, this.opts.locale)\n    this.locale.strings = Object.assign({}, defaultLocale.strings, this.opts.locale.strings)\n\n    this.translator = new Translator({locale: this.locale})\n    this.i18n = this.translator.translate.bind(this.translator)\n\n    this.hostname = this.opts.serverUrl\n\n    if (!this.hostname) {\n      throw new Error('Uppy Server hostname is required, please consult https://uppy.io/docs/server')\n    }\n\n    // Bind all event handlers for referencability\n    this.getMeta = this.getMeta.bind(this)\n    this.addFile = this.addFile.bind(this)\n    this.handleDrop = this.handleDrop.bind(this)\n    this.handleDragOver = this.handleDragOver.bind(this)\n    this.handleDragLeave = this.handleDragLeave.bind(this)\n\n    this.handlePaste = this.handlePaste.bind(this)\n\n    this.client = new RequestClient(uppy, { serverUrl: this.opts.serverUrl })\n  }\n\n  getFileNameFromUrl (url) {\n    return url.substring(url.lastIndexOf('/') + 1)\n  }\n\n  checkIfCorrectURL (url) {\n    if (!url) return false\n\n    const protocol = url.match(/^([a-z0-9]+):\\/\\//)[1]\n    if (protocol !== 'http' && protocol !== 'https') {\n      return false\n    }\n\n    return true\n  }\n\n  addProtocolToURL (url) {\n    const protocolRegex = /^[a-z0-9]+:\\/\\//\n    const defaultProtocol = 'http://'\n    if (protocolRegex.test(url)) {\n      return url\n    }\n\n    return defaultProtocol + url\n  }\n\n  getMeta (url) {\n    return this.client.post('url/meta', { url })\n      .then((res) => {\n        if (res.error) {\n          this.uppy.log('[URL] Error:')\n          this.uppy.log(res.error)\n          throw new Error('Failed to fetch the file')\n        }\n        return res\n      })\n  }\n\n  addFile (url) {\n    url = this.addProtocolToURL(url)\n    if (!this.checkIfCorrectURL(url)) {\n      this.uppy.log(`[URL] Incorrect URL entered: ${url}`)\n      this.uppy.info(this.i18n('enterCorrectUrl'), 'error', 4000)\n      return\n    }\n\n    return this.getMeta(url)\n      .then((meta) => {\n        const tagFile = {\n          source: this.id,\n          name: this.getFileNameFromUrl(url),\n          type: meta.type,\n          data: {\n            size: meta.size\n          },\n          isRemote: true,\n          body: {\n            url: url\n          },\n          remote: {\n            serverUrl: this.opts.serverUrl,\n            url: `${this.hostname}/url/get`,\n            body: {\n              fileId: url,\n              url: url\n            },\n            providerOptions: this.client.opts\n          }\n        }\n        return tagFile\n      })\n      .then((tagFile) => {\n        this.uppy.log('[Url] Adding remote file')\n        try {\n          this.uppy.addFile(tagFile)\n        } catch (err) {\n          // Nothing, restriction errors handled in Core\n        }\n      })\n      .then(() => {\n        const dashboard = this.uppy.getPlugin('Dashboard')\n        if (dashboard) dashboard.hideAllPanels()\n      })\n      .catch((err) => {\n        this.uppy.log(err)\n        this.uppy.info({\n          message: this.i18n('failedToFetch'),\n          details: err\n        }, 'error', 4000)\n      })\n  }\n\n  handleDrop (e) {\n    e.preventDefault()\n    if (e.dataTransfer.items) {\n      const items = toArray(e.dataTransfer.items)\n      items.forEach((item) => {\n        if (item.kind === 'string' && item.type === 'text/uri-list') {\n          item.getAsString((url) => {\n            this.uppy.log(`[URL] Adding file from dropped url: ${url}`)\n            this.addFile(url)\n          })\n        }\n      })\n    }\n  }\n\n  handleDragOver (e) {\n    e.preventDefault()\n    this.el.classList.add('drag')\n  }\n\n  handleDragLeave (e) {\n    e.preventDefault()\n    this.el.classList.remove('drag')\n  }\n\n  handlePaste (e) {\n    if (e.clipboardData.items) {\n      const items = toArray(e.clipboardData.items)\n\n      // When a file is pasted, it appears as two items: file name string, then\n      // the file itself; Url then treats file name string as URL, which is wrong.\n      // This makes sure Url ignores paste event if it contains an actual file\n      const hasFiles = items.filter(item => item.kind === 'file').length > 0\n      if (hasFiles) return\n\n      items.forEach((item) => {\n        if (item.kind === 'string' && item.type === 'text/plain') {\n          item.getAsString((url) => {\n            this.uppy.log(`[URL] Adding file from pasted url: ${url}`)\n            this.addFile(url)\n          })\n        }\n      })\n    }\n  }\n\n  render (state) {\n    return <UrlUI\n      i18n={this.i18n}\n      addFile={this.addFile} />\n  }\n\n  install () {\n    const target = this.opts.target\n    if (target) {\n      this.mount(target, this)\n    }\n\n    this.el.addEventListener('drop', this.handleDrop)\n    this.el.addEventListener('dragover', this.handleDragOver)\n    this.el.addEventListener('dragleave', this.handleDragLeave)\n    this.el.addEventListener('paste', this.handlePaste)\n  }\n\n  uninstall () {\n    this.el.removeEventListener('drop', this.handleDrop)\n    this.el.removeEventListener('dragover', this.handleDragOver)\n    this.el.removeEventListener('dragleave', this.handleDragLeave)\n    this.el.removeEventListener('paste', this.handlePaste)\n\n    this.unmount()\n  }\n}\n"]}