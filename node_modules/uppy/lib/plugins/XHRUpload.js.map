{"version":3,"sources":["../../src/plugins/XHRUpload.js"],"names":["Plugin","require","cuid","Translator","UppySocket","Provider","emitSocketProgress","getSocketHost","settle","limitPromises","buildResponseError","xhr","error","Error","data","request","module","exports","uppy","opts","type","id","title","defaultLocale","strings","timedOut","defaultOptions","formData","fieldName","method","metaFields","responseUrlFieldName","bundle","headers","locale","timeout","limit","withCredentials","getResponseData","responseText","response","parsedResponse","JSON","parse","err","console","log","getResponseError","translator","i18n","translate","bind","handleUpload","limitUploads","fn","getOptions","file","overrides","getState","xhrUpload","createProgressTimeout","timeoutHandler","self","isDone","onTimedOut","seconds","Math","ceil","aliveTimer","progress","clearTimeout","setTimeout","done","createFormDataUpload","formPost","FormData","Array","isArray","Object","keys","meta","forEach","item","append","createBareUpload","upload","current","total","resolve","reject","timer","abort","emit","XMLHttpRequest","addEventListener","ev","loaded","lengthComputable","uploader","bytesUploaded","bytesTotal","target","status","body","uploadURL","setFileState","name","open","toUpperCase","endpoint","header","setRequestHeader","send","on","removedFile","fileID","uploadRemote","fields","provider","remote","providerOptions","post","url","size","fieldname","metadata","then","res","token","host","serverUrl","socket","progressData","resp","close","errData","message","cause","uploadBundle","files","i","emitError","uploadFiles","actions","map","parseInt","length","isRemote","promises","action","limitedAction","fileIDs","getFile","install","setState","capabilities","bundled","addUploader","uninstall","removeUploader"],"mappings":";;;;;;;;;;AAAA,IAAMA,SAASC,QAAQ,gBAAR,CAAf;AACA,IAAMC,OAAOD,QAAQ,MAAR,CAAb;AACA,IAAME,aAAaF,QAAQ,oBAAR,CAAnB;AACA,IAAMG,aAAaH,QAAQ,oBAAR,CAAnB;AACA,IAAMI,WAAWJ,QAAQ,oBAAR,CAAjB;AACA,IAAMK,qBAAqBL,QAAQ,6BAAR,CAA3B;AACA,IAAMM,gBAAgBN,QAAQ,wBAAR,CAAtB;AACA,IAAMO,SAASP,QAAQ,iBAAR,CAAf;AACA,IAAMQ,gBAAgBR,QAAQ,wBAAR,CAAtB;;AAEA,SAASS,kBAAT,CAA6BC,GAA7B,EAAkCC,KAAlC,EAAyC;AACvC;AACA,MAAI,CAACA,KAAL,EAAYA,QAAQ,IAAIC,KAAJ,CAAU,cAAV,CAAR;AACZ;AACA,MAAI,OAAOD,KAAP,KAAiB,QAArB,EAA+BA,QAAQ,IAAIC,KAAJ,CAAUD,KAAV,CAAR;AAC/B;AACA,MAAI,EAAEA,iBAAiBC,KAAnB,CAAJ,EAA+B;AAC7BD,YAAQ,SAAc,IAAIC,KAAJ,CAAU,cAAV,CAAd,EAAyC,EAAEC,MAAMF,KAAR,EAAzC,CAAR;AACD;;AAEDA,QAAMG,OAAN,GAAgBJ,GAAhB;AACA,SAAOC,KAAP;AACD;;AAEDI,OAAOC,OAAP;AAAA;;AACE,qBAAaC,IAAb,EAAmBC,IAAnB,EAAyB;AAAA;;AAAA,iDACvB,mBAAMD,IAAN,EAAYC,IAAZ,CADuB;;AAEvB,UAAKC,IAAL,GAAY,UAAZ;AACA,UAAKC,EAAL,GAAU,WAAV;AACA,UAAKC,KAAL,GAAa,WAAb;;AAEA,QAAMC,gBAAgB;AACpBC,eAAS;AACPC,kBAAU;AADH;;AAKX;AANsB,KAAtB,CAOA,IAAMC,iBAAiB;AACrBC,gBAAU,IADW;AAErBC,iBAAW,SAFU;AAGrBC,cAAQ,MAHa;AAIrBC,kBAAY,IAJS;AAKrBC,4BAAsB,KALD;AAMrBC,cAAQ,KANa;AAOrBC,eAAS,EAPY;AAQrBC,cAAQX,aARa;AASrBY,eAAS,KAAK,IATO;AAUrBC,aAAO,CAVc;AAWrBC,uBAAiB,KAXI;AAYrB;;;;;;;;;;AAUAC,qBAtBqB,2BAsBJC,YAtBI,EAsBUC,QAtBV,EAsBoB;AACvC,YAAIC,iBAAiB,EAArB;AACA,YAAI;AACFA,2BAAiBC,KAAKC,KAAL,CAAWJ,YAAX,CAAjB;AACD,SAFD,CAEE,OAAOK,GAAP,EAAY;AACZC,kBAAQC,GAAR,CAAYF,GAAZ;AACD;;AAED,eAAOH,cAAP;AACD,OA/BoB;;AAgCrB;;;;;AAKAM,sBArCqB,4BAqCHR,YArCG,EAqCWC,QArCX,EAqCqB;AACxC,eAAO,IAAI3B,KAAJ,CAAU,cAAV,CAAP;AACD;AAvCoB,KAAvB;;AA0CA;AACA,UAAKM,IAAL,GAAY,SAAc,EAAd,EAAkBO,cAAlB,EAAkCP,IAAlC,CAAZ;AACA,UAAKe,MAAL,GAAc,SAAc,EAAd,EAAkBX,aAAlB,EAAiC,MAAKJ,IAAL,CAAUe,MAA3C,CAAd;AACA,UAAKA,MAAL,CAAYV,OAAZ,GAAsB,SAAc,EAAd,EAAkBD,cAAcC,OAAhC,EAAyC,MAAKL,IAAL,CAAUe,MAAV,CAAiBV,OAA1D,CAAtB;;AAEA;AACA,UAAKwB,UAAL,GAAkB,IAAI7C,UAAJ,CAAe,EAAE+B,QAAQ,MAAKA,MAAf,EAAf,CAAlB;AACA,UAAKe,IAAL,GAAY,MAAKD,UAAL,CAAgBE,SAAhB,CAA0BC,IAA1B,CAA+B,MAAKH,UAApC,CAAZ;;AAEA,UAAKI,YAAL,GAAoB,MAAKA,YAAL,CAAkBD,IAAlB,OAApB;;AAEA;AACA,QAAI,OAAO,MAAKhC,IAAL,CAAUiB,KAAjB,KAA2B,QAA3B,IAAuC,MAAKjB,IAAL,CAAUiB,KAAV,KAAoB,CAA/D,EAAkE;AAChE,YAAKiB,YAAL,GAAoB5C,cAAc,MAAKU,IAAL,CAAUiB,KAAxB,CAApB;AACD,KAFD,MAEO;AACL,YAAKiB,YAAL,GAAoB,UAACC,EAAD;AAAA,eAAQA,EAAR;AAAA,OAApB;AACD;;AAED,QAAI,MAAKnC,IAAL,CAAUa,MAAV,IAAoB,CAAC,MAAKb,IAAL,CAAUQ,QAAnC,EAA6C;AAC3C,YAAM,IAAId,KAAJ,CAAU,6DAAV,CAAN;AACD;AA3EsB;AA4ExB;;AA7EH,sBA+EE0C,UA/EF,uBA+EcC,IA/Ed,EA+EoB;AAChB,QAAMC,YAAY,KAAKvC,IAAL,CAAUwC,QAAV,GAAqBC,SAAvC;AACA,QAAMxC,OAAO,SAAc,EAAd,EACX,KAAKA,IADM,EAEXsC,aAAa,EAFF,EAGXD,KAAKG,SAAL,IAAkB,EAHP,CAAb;AAKAxC,SAAKc,OAAL,GAAe,EAAf;AACA,aAAcd,KAAKc,OAAnB,EAA4B,KAAKd,IAAL,CAAUc,OAAtC;AACA,QAAIwB,SAAJ,EAAe;AACb,eAActC,KAAKc,OAAnB,EAA4BwB,UAAUxB,OAAtC;AACD;AACD,QAAIuB,KAAKG,SAAT,EAAoB;AAClB,eAAcxC,KAAKc,OAAnB,EAA4BuB,KAAKG,SAAL,CAAe1B,OAA3C;AACD;;AAED,WAAOd,IAAP;AACD,GAhGH;;AAkGE;AACA;AACA;AACA;;;AArGF,sBAsGEyC,qBAtGF,kCAsGyBzB,OAtGzB,EAsGkC0B,cAtGlC,EAsGkD;AAC9C,QAAM3C,OAAO,KAAKA,IAAlB;AACA,QAAM4C,OAAO,IAAb;AACA,QAAIC,SAAS,KAAb;;AAEA,aAASC,UAAT,GAAuB;AACrB9C,WAAK4B,GAAL;AACA,UAAMlC,QAAQ,IAAIC,KAAJ,CAAUiD,KAAKb,IAAL,CAAU,UAAV,EAAsB,EAAEgB,SAASC,KAAKC,IAAL,CAAUhC,UAAU,IAApB,CAAX,EAAtB,CAAV,CAAd;AACA0B,qBAAejD,KAAf;AACD;;AAED,QAAIwD,aAAa,IAAjB;AACA,aAASC,QAAT,GAAqB;AACnB;AACA;AACA;AACA,UAAIN,MAAJ,EAAY;;AAEZ,UAAI5B,UAAU,CAAd,EAAiB;AACf,YAAIiC,UAAJ,EAAgBE,aAAaF,UAAb;AAChBA,qBAAaG,WAAWP,UAAX,EAAuB7B,OAAvB,CAAb;AACD;AACF;;AAED,aAASqC,IAAT,GAAiB;AACftD,WAAK4B,GAAL;AACA,UAAIsB,UAAJ,EAAgB;AACdE,qBAAaF,UAAb;AACAA,qBAAa,IAAb;AACD;AACDL,eAAS,IAAT;AACD;;AAED,WAAO;AACLM,wBADK;AAELG;AAFK,KAAP;AAID,GA3IH;;AAAA,sBA6IEC,oBA7IF,iCA6IwBjB,IA7IxB,EA6I8BrC,IA7I9B,EA6IoC;AAChC,QAAMuD,WAAW,IAAIC,QAAJ,EAAjB;;AAEA,QAAM7C,aAAa8C,MAAMC,OAAN,CAAc1D,KAAKW,UAAnB,IACfX,KAAKW;AACP;AAFiB,MAGfgD,OAAOC,IAAP,CAAYvB,KAAKwB,IAAjB,CAHJ;AAIAlD,eAAWmD,OAAX,CAAmB,UAACC,IAAD,EAAU;AAC3BR,eAASS,MAAT,CAAgBD,IAAhB,EAAsB1B,KAAKwB,IAAL,CAAUE,IAAV,CAAtB;AACD,KAFD;;AAIAR,aAASS,MAAT,CAAgBhE,KAAKS,SAArB,EAAgC4B,KAAK1C,IAArC;;AAEA,WAAO4D,QAAP;AACD,GA3JH;;AAAA,sBA6JEU,gBA7JF,6BA6JoB5B,IA7JpB,EA6J0BrC,IA7J1B,EA6JgC;AAC5B,WAAOqC,KAAK1C,IAAZ;AACD,GA/JH;;AAAA,sBAiKEuE,MAjKF,mBAiKU7B,IAjKV,EAiKgB8B,OAjKhB,EAiKyBC,KAjKzB,EAiKgC;AAAA;;AAC5B,QAAMpE,OAAO,KAAKoC,UAAL,CAAgBC,IAAhB,CAAb;;AAEA,SAAKtC,IAAL,CAAU4B,GAAV,gBAA2BwC,OAA3B,YAAyCC,KAAzC;AACA,WAAO,aAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACtC,UAAM3E,OAAOK,KAAKQ,QAAL,GACT,OAAK8C,oBAAL,CAA0BjB,IAA1B,EAAgCrC,IAAhC,CADS,GAET,OAAKiE,gBAAL,CAAsB5B,IAAtB,EAA4BrC,IAA5B,CAFJ;;AAIA,UAAMuE,QAAQ,OAAK9B,qBAAL,CAA2BzC,KAAKgB,OAAhC,EAAyC,UAACvB,KAAD,EAAW;AAChED,YAAIgF,KAAJ;AACA,eAAKzE,IAAL,CAAU0E,IAAV,CAAe,cAAf,EAA+BpC,IAA/B,EAAqC5C,KAArC;AACA6E,eAAO7E,KAAP;AACD,OAJa,CAAd;;AAMA,UAAMD,MAAM,IAAIkF,cAAJ,EAAZ;AACA,UAAMxE,KAAKnB,MAAX;;AAEAS,UAAI0E,MAAJ,CAAWS,gBAAX,CAA4B,WAA5B,EAAyC,UAACC,EAAD,EAAQ;AAC/C,eAAK7E,IAAL,CAAU4B,GAAV,kBAA6BzB,EAA7B;AACA;AACAqE,cAAMrB,QAAN;AACD,OAJD;;AAMA1D,UAAI0E,MAAJ,CAAWS,gBAAX,CAA4B,UAA5B,EAAwC,UAACC,EAAD,EAAQ;AAC9C,eAAK7E,IAAL,CAAU4B,GAAV,kBAA6BzB,EAA7B,mBAA6C0E,GAAGC,MAAhD,WAA4DD,GAAGR,KAA/D;AACAG,cAAMrB,QAAN;;AAEA,YAAI0B,GAAGE,gBAAP,EAAyB;AACvB,iBAAK/E,IAAL,CAAU0E,IAAV,CAAe,iBAAf,EAAkCpC,IAAlC,EAAwC;AACtC0C,4BADsC;AAEtCC,2BAAeJ,GAAGC,MAFoB;AAGtCI,wBAAYL,GAAGR;AAHuB,WAAxC;AAKD;AACF,OAXD;;AAaA5E,UAAImF,gBAAJ,CAAqB,MAArB,EAA6B,UAACC,EAAD,EAAQ;AACnC,eAAK7E,IAAL,CAAU4B,GAAV,kBAA6BzB,EAA7B;AACAqE,cAAMlB,IAAN;;AAEA,YAAIuB,GAAGM,MAAH,CAAUC,MAAV,IAAoB,GAApB,IAA2BP,GAAGM,MAAH,CAAUC,MAAV,GAAmB,GAAlD,EAAuD;AACrD,cAAMC,OAAOpF,KAAKmB,eAAL,CAAqB3B,IAAI4B,YAAzB,EAAuC5B,GAAvC,CAAb;AACA,cAAM6F,YAAYD,KAAKpF,KAAKY,oBAAV,CAAlB;;AAEA,cAAMS,WAAW;AACf8D,oBAAQP,GAAGM,MAAH,CAAUC,MADH;AAEfC,sBAFe;AAGfC;AAHe,WAAjB;;AAMA,iBAAKtF,IAAL,CAAUuF,YAAV,CAAuBjD,KAAKnC,EAA5B,EAAgC,EAAEmB,kBAAF,EAAhC;;AAEA,iBAAKtB,IAAL,CAAU0E,IAAV,CAAe,gBAAf,EAAiCpC,IAAjC,EAAuC+C,IAAvC,EAA6CC,SAA7C;;AAEA,cAAIA,SAAJ,EAAe;AACb,mBAAKtF,IAAL,CAAU4B,GAAV,eAA0BU,KAAKkD,IAA/B,cAA4ClD,KAAKgD,SAAjD;AACD;;AAED,iBAAOhB,QAAQhC,IAAR,CAAP;AACD,SAnBD,MAmBO;AACL,cAAM+C,QAAOpF,KAAKmB,eAAL,CAAqB3B,IAAI4B,YAAzB,EAAuC5B,GAAvC,CAAb;AACA,cAAMC,QAAQF,mBAAmBC,GAAnB,EAAwBQ,KAAK4B,gBAAL,CAAsBpC,IAAI4B,YAA1B,EAAwC5B,GAAxC,CAAxB,CAAd;;AAEA,cAAM6B,YAAW;AACf8D,oBAAQP,GAAGM,MAAH,CAAUC,MADH;AAEfC;AAFe,WAAjB;;AAKA,iBAAKrF,IAAL,CAAUuF,YAAV,CAAuBjD,KAAKnC,EAA5B,EAAgC,EAAEmB,mBAAF,EAAhC;;AAEA,iBAAKtB,IAAL,CAAU0E,IAAV,CAAe,cAAf,EAA+BpC,IAA/B,EAAqC5C,KAArC;AACA,iBAAO6E,OAAO7E,KAAP,CAAP;AACD;AACF,OArCD;;AAuCAD,UAAImF,gBAAJ,CAAqB,OAArB,EAA8B,UAACC,EAAD,EAAQ;AACpC,eAAK7E,IAAL,CAAU4B,GAAV,kBAA6BzB,EAA7B;AACAqE,cAAMlB,IAAN;;AAEA,YAAM5D,QAAQF,mBAAmBC,GAAnB,EAAwBQ,KAAK4B,gBAAL,CAAsBpC,IAAI4B,YAA1B,EAAwC5B,GAAxC,CAAxB,CAAd;AACA,eAAKO,IAAL,CAAU0E,IAAV,CAAe,cAAf,EAA+BpC,IAA/B,EAAqC5C,KAArC;AACA,eAAO6E,OAAO7E,KAAP,CAAP;AACD,OAPD;;AASAD,UAAIgG,IAAJ,CAASxF,KAAKU,MAAL,CAAY+E,WAAZ,EAAT,EAAoCzF,KAAK0F,QAAzC,EAAmD,IAAnD;;AAEAlG,UAAI0B,eAAJ,GAAsBlB,KAAKkB,eAA3B;;AAEAyC,aAAOC,IAAP,CAAY5D,KAAKc,OAAjB,EAA0BgD,OAA1B,CAAkC,UAAC6B,MAAD,EAAY;AAC5CnG,YAAIoG,gBAAJ,CAAqBD,MAArB,EAA6B3F,KAAKc,OAAL,CAAa6E,MAAb,CAA7B;AACD,OAFD;;AAIAnG,UAAIqG,IAAJ,CAASlG,IAAT;;AAEA,aAAKI,IAAL,CAAU+F,EAAV,CAAa,cAAb,EAA6B,UAACC,WAAD,EAAiB;AAC5C,YAAIA,YAAY7F,EAAZ,KAAmBmC,KAAKnC,EAA5B,EAAgC;AAC9BqE,gBAAMlB,IAAN;AACA7D,cAAIgF,KAAJ;AACD;AACF,OALD;;AAOA,aAAKzE,IAAL,CAAU+F,EAAV,CAAa,eAAb,EAA8B,UAACE,MAAD,EAAY;AACxC,YAAIA,WAAW3D,KAAKnC,EAApB,EAAwB;AACtBqE,gBAAMlB,IAAN;AACA7D,cAAIgF,KAAJ;AACD;AACF,OALD;;AAOA,aAAKzE,IAAL,CAAU+F,EAAV,CAAa,YAAb,EAA2B,YAAM;AAC/BvB,cAAMlB,IAAN;AACA7D,YAAIgF,KAAJ;AACD,OAHD;AAID,KA7GM,CAAP;AA8GD,GAnRH;;AAAA,sBAqREyB,YArRF,yBAqRgB5D,IArRhB,EAqRsB8B,OArRtB,EAqR+BC,KArR/B,EAqRsC;AAAA;;AAClC,QAAMpE,OAAO,KAAKoC,UAAL,CAAgBC,IAAhB,CAAb;AACA,WAAO,aAAY,UAACgC,OAAD,EAAUC,MAAV,EAAqB;AACtC,UAAM4B,SAAS,EAAf;AACA,UAAMvF,aAAa8C,MAAMC,OAAN,CAAc1D,KAAKW,UAAnB,IACfX,KAAKW;AACP;AAFiB,QAGfgD,OAAOC,IAAP,CAAYvB,KAAKwB,IAAjB,CAHJ;;AAKAlD,iBAAWmD,OAAX,CAAmB,UAACyB,IAAD,EAAU;AAC3BW,eAAOX,IAAP,IAAelD,KAAKwB,IAAL,CAAU0B,IAAV,CAAf;AACD,OAFD;;AAIA,UAAMY,WAAW,IAAIjH,QAAJ,CAAa,OAAKa,IAAlB,EAAwBsC,KAAK+D,MAAL,CAAYC,eAApC,CAAjB;AACAF,eAASG,IAAT,CACEjE,KAAK+D,MAAL,CAAYG,GADd,EAEE,SAAc,EAAd,EAAkBlE,KAAK+D,MAAL,CAAYhB,IAA9B,EAAoC;AAClCM,kBAAU1F,KAAK0F,QADmB;AAElCc,cAAMnE,KAAK1C,IAAL,CAAU6G,IAFkB;AAGlCC,mBAAWzG,KAAKS,SAHkB;AAIlCiG,kBAAUR,MAJwB;AAKlCpF,iBAASd,KAAKc;AALoB,OAApC,CAFF,EAUC6F,IAVD,CAUM,UAACC,GAAD,EAAS;AACb,YAAMC,QAAQD,IAAIC,KAAlB;AACA,YAAMC,OAAO1H,cAAciD,KAAK+D,MAAL,CAAYW,SAA1B,CAAb;AACA,YAAMC,SAAS,IAAI/H,UAAJ,CAAe,EAAEiG,QAAW4B,IAAX,aAAuBD,KAAzB,EAAf,CAAf;;AAEAG,eAAOlB,EAAP,CAAU,UAAV,EAAsB,UAACmB,YAAD;AAAA,iBAAkB9H,2BAAyB8H,YAAzB,EAAuC5E,IAAvC,CAAlB;AAAA,SAAtB;;AAEA2E,eAAOlB,EAAP,CAAU,SAAV,EAAqB,UAACnG,IAAD,EAAU;AAC7B,cAAMuH,OAAOlH,KAAKmB,eAAL,CAAqBxB,KAAK0B,QAAL,CAAcD,YAAnC,EAAiDzB,KAAK0B,QAAtD,CAAb;AACA,cAAMgE,YAAY6B,KAAKlH,KAAKY,oBAAV,CAAlB;AACA,iBAAKb,IAAL,CAAU0E,IAAV,CAAe,gBAAf,EAAiCpC,IAAjC,EAAuC6E,IAAvC,EAA6C7B,SAA7C;AACA2B,iBAAOG,KAAP;AACA,iBAAO9C,SAAP;AACD,SAND;;AAQA2C,eAAOlB,EAAP,CAAU,OAAV,EAAmB,UAACsB,OAAD,EAAa;AAC9B,cAAMF,OAAOE,QAAQ/F,QAArB;AACA,cAAM5B,QAAQyH,OACVlH,KAAK4B,gBAAL,CAAsBsF,KAAK9F,YAA3B,EAAyC8F,IAAzC,CADU,GAEV,SAAc,IAAIxH,KAAJ,CAAU0H,QAAQ3H,KAAR,CAAc4H,OAAxB,CAAd,EAAgD,EAAEC,OAAOF,QAAQ3H,KAAjB,EAAhD,CAFJ;AAGA,iBAAKM,IAAL,CAAU0E,IAAV,CAAe,cAAf,EAA+BpC,IAA/B,EAAqC5C,KAArC;AACA6E,iBAAO7E,KAAP;AACD,SAPD;AAQD,OAjCD;AAkCD,KA9CM,CAAP;AA+CD,GAtUH;;AAAA,sBAwUE8H,YAxUF,yBAwUgBC,KAxUhB,EAwUuB;AAAA;;AACnB,WAAO,aAAY,UAACnD,OAAD,EAAUC,MAAV,EAAqB;AACtC,UAAMoB,WAAW,OAAK1F,IAAL,CAAU0F,QAA3B;AACA,UAAMhF,SAAS,OAAKV,IAAL,CAAUU,MAAzB;;AAEA,UAAMF,WAAW,IAAIgD,QAAJ,EAAjB;AACAgE,YAAM1D,OAAN,CAAc,UAACzB,IAAD,EAAOoF,CAAP,EAAa;AACzB,YAAMzH,OAAO,OAAKoC,UAAL,CAAgBC,IAAhB,CAAb;AACA7B,iBAASwD,MAAT,CAAgBhE,KAAKS,SAArB,EAAgC4B,KAAK1C,IAArC;AACD,OAHD;;AAKA,UAAMH,MAAM,IAAIkF,cAAJ,EAAZ;;AAEAlF,UAAI0B,eAAJ,GAAsB,OAAKlB,IAAL,CAAUkB,eAAhC;;AAEA,UAAMqD,QAAQ,OAAK9B,qBAAL,CAA2B,OAAKzC,IAAL,CAAUgB,OAArC,EAA8C,UAACvB,KAAD,EAAW;AACrED,YAAIgF,KAAJ;AACAkD,kBAAUjI,KAAV;AACA6E,eAAO7E,KAAP;AACD,OAJa,CAAd;;AAMA,UAAMiI,YAAY,SAAZA,SAAY,CAACjI,KAAD,EAAW;AAC3B+H,cAAM1D,OAAN,CAAc,UAACzB,IAAD,EAAU;AACtB,iBAAKtC,IAAL,CAAU0E,IAAV,CAAe,cAAf,EAA+BpC,IAA/B,EAAqC5C,KAArC;AACD,SAFD;AAGD,OAJD;;AAMAD,UAAI0E,MAAJ,CAAWS,gBAAX,CAA4B,WAA5B,EAAyC,UAACC,EAAD,EAAQ;AAC/C,eAAK7E,IAAL,CAAU4B,GAAV,CAAc,sCAAd;AACA4C,cAAMrB,QAAN;AACD,OAHD;;AAKA1D,UAAI0E,MAAJ,CAAWS,gBAAX,CAA4B,UAA5B,EAAwC,UAACC,EAAD,EAAQ;AAC9CL,cAAMrB,QAAN;;AAEA,YAAI,CAAC0B,GAAGE,gBAAR,EAA0B;;AAE1B0C,cAAM1D,OAAN,CAAc,UAACzB,IAAD,EAAU;AACtB,iBAAKtC,IAAL,CAAU0E,IAAV,CAAe,iBAAf,EAAkCpC,IAAlC,EAAwC;AACtC0C,4BADsC;AAEtCC,2BAAeJ,GAAGC,MAAH,GAAYD,GAAGR,KAAf,GAAuB/B,KAAKmE,IAFL;AAGtCvB,wBAAY5C,KAAKmE;AAHqB,WAAxC;AAKD,SAND;AAOD,OAZD;;AAcAhH,UAAImF,gBAAJ,CAAqB,MAArB,EAA6B,UAACC,EAAD,EAAQ;AACnCL,cAAMlB,IAAN;;AAEA,YAAIuB,GAAGM,MAAH,CAAUC,MAAV,IAAoB,GAApB,IAA2BP,GAAGM,MAAH,CAAUC,MAAV,GAAmB,GAAlD,EAAuD;AACrD,cAAM+B,OAAO,OAAKlH,IAAL,CAAUmB,eAAV,CAA0B3B,IAAI4B,YAA9B,EAA4C5B,GAA5C,CAAb;AACAgI,gBAAM1D,OAAN,CAAc,UAACzB,IAAD,EAAU;AACtB,mBAAKtC,IAAL,CAAU0E,IAAV,CAAe,gBAAf,EAAiCpC,IAAjC,EAAuC6E,IAAvC;AACD,WAFD;AAGA,iBAAO7C,SAAP;AACD;;AAED,YAAM5E,QAAQ,OAAKO,IAAL,CAAU4B,gBAAV,CAA2BpC,IAAI4B,YAA/B,EAA6C5B,GAA7C,KAAqD,IAAIE,KAAJ,CAAU,cAAV,CAAnE;AACAD,cAAMG,OAAN,GAAgBJ,GAAhB;AACAkI,kBAAUjI,KAAV;AACA,eAAO6E,OAAO7E,KAAP,CAAP;AACD,OAfD;;AAiBAD,UAAImF,gBAAJ,CAAqB,OAArB,EAA8B,UAACC,EAAD,EAAQ;AACpCL,cAAMlB,IAAN;;AAEA,YAAM5D,QAAQ,OAAKO,IAAL,CAAU4B,gBAAV,CAA2BpC,IAAI4B,YAA/B,EAA6C5B,GAA7C,KAAqD,IAAIE,KAAJ,CAAU,cAAV,CAAnE;AACAgI,kBAAUjI,KAAV;AACA,eAAO6E,OAAO7E,KAAP,CAAP;AACD,OAND;;AAQA,aAAKM,IAAL,CAAU+F,EAAV,CAAa,YAAb,EAA2B,YAAM;AAC/BvB,cAAMlB,IAAN;AACA7D,YAAIgF,KAAJ;AACD,OAHD;;AAKAhF,UAAIgG,IAAJ,CAAS9E,OAAO+E,WAAP,EAAT,EAA+BC,QAA/B,EAAyC,IAAzC;;AAEAlG,UAAI0B,eAAJ,GAAsB,OAAKlB,IAAL,CAAUkB,eAAhC;;AAEAyC,aAAOC,IAAP,CAAY,OAAK5D,IAAL,CAAUc,OAAtB,EAA+BgD,OAA/B,CAAuC,UAAC6B,MAAD,EAAY;AACjDnG,YAAIoG,gBAAJ,CAAqBD,MAArB,EAA6B,OAAK3F,IAAL,CAAUc,OAAV,CAAkB6E,MAAlB,CAA7B;AACD,OAFD;;AAIAnG,UAAIqG,IAAJ,CAASrF,QAAT;;AAEAgH,YAAM1D,OAAN,CAAc,UAACzB,IAAD,EAAU;AACtB,eAAKtC,IAAL,CAAU0E,IAAV,CAAe,gBAAf,EAAiCpC,IAAjC;AACD,OAFD;AAGD,KAxFM,CAAP;AAyFD,GAlaH;;AAAA,sBAoaEsF,WApaF,wBAoaeH,KApaf,EAoasB;AAAA;;AAClB,QAAMI,UAAUJ,MAAMK,GAAN,CAAU,UAACxF,IAAD,EAAOoF,CAAP,EAAa;AACrC,UAAMtD,UAAU2D,SAASL,CAAT,EAAY,EAAZ,IAAkB,CAAlC;AACA,UAAMrD,QAAQoD,MAAMO,MAApB;;AAEA,UAAI1F,KAAK5C,KAAT,EAAgB;AACd,eAAO;AAAA,iBAAM,SAAQ6E,MAAR,CAAe,IAAI5E,KAAJ,CAAU2C,KAAK5C,KAAf,CAAf,CAAN;AAAA,SAAP;AACD,OAFD,MAEO,IAAI4C,KAAK2F,QAAT,EAAmB;AACxB;AACA;AACA,eAAKjI,IAAL,CAAU0E,IAAV,CAAe,gBAAf,EAAiCpC,IAAjC;AACA,eAAO,OAAK4D,YAAL,CAAkBjE,IAAlB,SAA6BK,IAA7B,EAAmC8B,OAAnC,EAA4CC,KAA5C,CAAP;AACD,OALM,MAKA;AACL,eAAKrE,IAAL,CAAU0E,IAAV,CAAe,gBAAf,EAAiCpC,IAAjC;AACA,eAAO,OAAK6B,MAAL,CAAYlC,IAAZ,SAAuBK,IAAvB,EAA6B8B,OAA7B,EAAsCC,KAAtC,CAAP;AACD;AACF,KAfe,CAAhB;;AAiBA,QAAM6D,WAAWL,QAAQC,GAAR,CAAY,UAACK,MAAD,EAAY;AACvC,UAAMC,gBAAgB,OAAKjG,YAAL,CAAkBgG,MAAlB,CAAtB;AACA,aAAOC,eAAP;AACD,KAHgB,CAAjB;;AAKA,WAAO9I,OAAO4I,QAAP,CAAP;AACD,GA5bH;;AAAA,sBA8bEhG,YA9bF,yBA8bgBmG,OA9bhB,EA8byB;AAAA;;AACrB,QAAIA,QAAQL,MAAR,KAAmB,CAAvB,EAA0B;AACxB,WAAKhI,IAAL,CAAU4B,GAAV,CAAc,iCAAd;AACA,aAAO,SAAQ0C,OAAR,EAAP;AACD;;AAED,SAAKtE,IAAL,CAAU4B,GAAV,CAAc,0BAAd;AACA,QAAM6F,QAAQY,QAAQP,GAAR,CAAY,UAAC7B,MAAD;AAAA,aAAY,OAAKjG,IAAL,CAAUsI,OAAV,CAAkBrC,MAAlB,CAAZ;AAAA,KAAZ,CAAd;;AAEA,QAAI,KAAKhG,IAAL,CAAUa,MAAd,EAAsB;AACpB,aAAO,KAAK0G,YAAL,CAAkBC,KAAlB,CAAP;AACD;;AAED,WAAO,KAAKG,WAAL,CAAiBH,KAAjB,EAAwBb,IAAxB,CAA6B;AAAA,aAAM,IAAN;AAAA,KAA7B,CAAP;AACD,GA5cH;;AAAA,sBA8cE2B,OA9cF,sBA8ca;AACT,QAAI,KAAKtI,IAAL,CAAUa,MAAd,EAAsB;AACpB,WAAKd,IAAL,CAAUwI,QAAV,CAAmB;AACjBC,sBAAc,SAAc,EAAd,EAAkB,KAAKzI,IAAL,CAAUwC,QAAV,GAAqBiG,YAAvC,EAAqD;AACjEC,mBAAS;AADwD,SAArD;AADG,OAAnB;AAKD;;AAED,SAAK1I,IAAL,CAAU2I,WAAV,CAAsB,KAAKzG,YAA3B;AACD,GAxdH;;AAAA,sBA0dE0G,SA1dF,wBA0de;AACX,QAAI,KAAK3I,IAAL,CAAUa,MAAd,EAAsB;AACpB,WAAKd,IAAL,CAAUwI,QAAV,CAAmB;AACjBC,sBAAc,SAAc,EAAd,EAAkB,KAAKzI,IAAL,CAAUwC,QAAV,GAAqBiG,YAAvC,EAAqD;AACjEC,mBAAS;AADwD,SAArD;AADG,OAAnB;AAKD;;AAED,SAAK1I,IAAL,CAAU6I,cAAV,CAAyB,KAAK3G,YAA9B;AACD,GApeH;;AAAA;AAAA,EAAyCpD,MAAzC","file":"XHRUpload.js","sourcesContent":["const Plugin = require('../core/Plugin')\nconst cuid = require('cuid')\nconst Translator = require('../core/Translator')\nconst UppySocket = require('../core/UppySocket')\nconst Provider = require('../server/Provider')\nconst emitSocketProgress = require('../utils/emitSocketProgress')\nconst getSocketHost = require('../utils/getSocketHost')\nconst settle = require('../utils/settle')\nconst limitPromises = require('../utils/limitPromises')\n\nfunction buildResponseError (xhr, error) {\n  // No error message\n  if (!error) error = new Error('Upload error')\n  // Got an error message string\n  if (typeof error === 'string') error = new Error(error)\n  // Got something else\n  if (!(error instanceof Error)) {\n    error = Object.assign(new Error('Upload error'), { data: error })\n  }\n\n  error.request = xhr\n  return error\n}\n\nmodule.exports = class XHRUpload extends Plugin {\n  constructor (uppy, opts) {\n    super(uppy, opts)\n    this.type = 'uploader'\n    this.id = 'XHRUpload'\n    this.title = 'XHRUpload'\n\n    const defaultLocale = {\n      strings: {\n        timedOut: 'Upload stalled for %{seconds} seconds, aborting.'\n      }\n    }\n\n    // Default options\n    const defaultOptions = {\n      formData: true,\n      fieldName: 'files[]',\n      method: 'post',\n      metaFields: null,\n      responseUrlFieldName: 'url',\n      bundle: false,\n      headers: {},\n      locale: defaultLocale,\n      timeout: 30 * 1000,\n      limit: 0,\n      withCredentials: false,\n      /**\n       * @typedef respObj\n       * @property {string} responseText\n       * @property {number} status\n       * @property {string} statusText\n       * @property {Object.<string, string>} headers\n       *\n       * @param {string} responseText the response body string\n       * @param {XMLHttpRequest | respObj} response the response object (XHR or similar)\n       */\n      getResponseData (responseText, response) {\n        let parsedResponse = {}\n        try {\n          parsedResponse = JSON.parse(responseText)\n        } catch (err) {\n          console.log(err)\n        }\n\n        return parsedResponse\n      },\n      /**\n       *\n       * @param {string} responseText the response body string\n       * @param {XMLHttpRequest | respObj} response the response object (XHR or similar)\n       */\n      getResponseError (responseText, response) {\n        return new Error('Upload error')\n      }\n    }\n\n    // Merge default options with the ones set by user\n    this.opts = Object.assign({}, defaultOptions, opts)\n    this.locale = Object.assign({}, defaultLocale, this.opts.locale)\n    this.locale.strings = Object.assign({}, defaultLocale.strings, this.opts.locale.strings)\n\n    // i18n\n    this.translator = new Translator({ locale: this.locale })\n    this.i18n = this.translator.translate.bind(this.translator)\n\n    this.handleUpload = this.handleUpload.bind(this)\n\n    // Simultaneous upload limiting is shared across all uploads with this plugin.\n    if (typeof this.opts.limit === 'number' && this.opts.limit !== 0) {\n      this.limitUploads = limitPromises(this.opts.limit)\n    } else {\n      this.limitUploads = (fn) => fn\n    }\n\n    if (this.opts.bundle && !this.opts.formData) {\n      throw new Error('`opts.formData` must be true when `opts.bundle` is enabled.')\n    }\n  }\n\n  getOptions (file) {\n    const overrides = this.uppy.getState().xhrUpload\n    const opts = Object.assign({},\n      this.opts,\n      overrides || {},\n      file.xhrUpload || {}\n    )\n    opts.headers = {}\n    Object.assign(opts.headers, this.opts.headers)\n    if (overrides) {\n      Object.assign(opts.headers, overrides.headers)\n    }\n    if (file.xhrUpload) {\n      Object.assign(opts.headers, file.xhrUpload.headers)\n    }\n\n    return opts\n  }\n\n  // Helper to abort upload requests if there has not been any progress for `timeout` ms.\n  // Create an instance using `timer = createProgressTimeout(10000, onTimeout)`\n  // Call `timer.progress()` to signal that there has been progress of any kind.\n  // Call `timer.done()` when the upload has completed.\n  createProgressTimeout (timeout, timeoutHandler) {\n    const uppy = this.uppy\n    const self = this\n    let isDone = false\n\n    function onTimedOut () {\n      uppy.log(`[XHRUpload] timed out`)\n      const error = new Error(self.i18n('timedOut', { seconds: Math.ceil(timeout / 1000) }))\n      timeoutHandler(error)\n    }\n\n    let aliveTimer = null\n    function progress () {\n      // Some browsers fire another progress event when the upload is\n      // cancelled, so we have to ignore progress after the timer was\n      // told to stop.\n      if (isDone) return\n\n      if (timeout > 0) {\n        if (aliveTimer) clearTimeout(aliveTimer)\n        aliveTimer = setTimeout(onTimedOut, timeout)\n      }\n    }\n\n    function done () {\n      uppy.log(`[XHRUpload] timer done`)\n      if (aliveTimer) {\n        clearTimeout(aliveTimer)\n        aliveTimer = null\n      }\n      isDone = true\n    }\n\n    return {\n      progress,\n      done\n    }\n  }\n\n  createFormDataUpload (file, opts) {\n    const formPost = new FormData()\n\n    const metaFields = Array.isArray(opts.metaFields)\n      ? opts.metaFields\n      // Send along all fields by default.\n      : Object.keys(file.meta)\n    metaFields.forEach((item) => {\n      formPost.append(item, file.meta[item])\n    })\n\n    formPost.append(opts.fieldName, file.data)\n\n    return formPost\n  }\n\n  createBareUpload (file, opts) {\n    return file.data\n  }\n\n  upload (file, current, total) {\n    const opts = this.getOptions(file)\n\n    this.uppy.log(`uploading ${current} of ${total}`)\n    return new Promise((resolve, reject) => {\n      const data = opts.formData\n        ? this.createFormDataUpload(file, opts)\n        : this.createBareUpload(file, opts)\n\n      const timer = this.createProgressTimeout(opts.timeout, (error) => {\n        xhr.abort()\n        this.uppy.emit('upload-error', file, error)\n        reject(error)\n      })\n\n      const xhr = new XMLHttpRequest()\n      const id = cuid()\n\n      xhr.upload.addEventListener('loadstart', (ev) => {\n        this.uppy.log(`[XHRUpload] ${id} started`)\n        // Begin checking for timeouts when loading starts.\n        timer.progress()\n      })\n\n      xhr.upload.addEventListener('progress', (ev) => {\n        this.uppy.log(`[XHRUpload] ${id} progress: ${ev.loaded} / ${ev.total}`)\n        timer.progress()\n\n        if (ev.lengthComputable) {\n          this.uppy.emit('upload-progress', file, {\n            uploader: this,\n            bytesUploaded: ev.loaded,\n            bytesTotal: ev.total\n          })\n        }\n      })\n\n      xhr.addEventListener('load', (ev) => {\n        this.uppy.log(`[XHRUpload] ${id} finished`)\n        timer.done()\n\n        if (ev.target.status >= 200 && ev.target.status < 300) {\n          const body = opts.getResponseData(xhr.responseText, xhr)\n          const uploadURL = body[opts.responseUrlFieldName]\n\n          const response = {\n            status: ev.target.status,\n            body,\n            uploadURL\n          }\n\n          this.uppy.setFileState(file.id, { response })\n\n          this.uppy.emit('upload-success', file, body, uploadURL)\n\n          if (uploadURL) {\n            this.uppy.log(`Download ${file.name} from ${file.uploadURL}`)\n          }\n\n          return resolve(file)\n        } else {\n          const body = opts.getResponseData(xhr.responseText, xhr)\n          const error = buildResponseError(xhr, opts.getResponseError(xhr.responseText, xhr))\n\n          const response = {\n            status: ev.target.status,\n            body\n          }\n\n          this.uppy.setFileState(file.id, { response })\n\n          this.uppy.emit('upload-error', file, error)\n          return reject(error)\n        }\n      })\n\n      xhr.addEventListener('error', (ev) => {\n        this.uppy.log(`[XHRUpload] ${id} errored`)\n        timer.done()\n\n        const error = buildResponseError(xhr, opts.getResponseError(xhr.responseText, xhr))\n        this.uppy.emit('upload-error', file, error)\n        return reject(error)\n      })\n\n      xhr.open(opts.method.toUpperCase(), opts.endpoint, true)\n\n      xhr.withCredentials = opts.withCredentials\n\n      Object.keys(opts.headers).forEach((header) => {\n        xhr.setRequestHeader(header, opts.headers[header])\n      })\n\n      xhr.send(data)\n\n      this.uppy.on('file-removed', (removedFile) => {\n        if (removedFile.id === file.id) {\n          timer.done()\n          xhr.abort()\n        }\n      })\n\n      this.uppy.on('upload-cancel', (fileID) => {\n        if (fileID === file.id) {\n          timer.done()\n          xhr.abort()\n        }\n      })\n\n      this.uppy.on('cancel-all', () => {\n        timer.done()\n        xhr.abort()\n      })\n    })\n  }\n\n  uploadRemote (file, current, total) {\n    const opts = this.getOptions(file)\n    return new Promise((resolve, reject) => {\n      const fields = {}\n      const metaFields = Array.isArray(opts.metaFields)\n        ? opts.metaFields\n        // Send along all fields by default.\n        : Object.keys(file.meta)\n\n      metaFields.forEach((name) => {\n        fields[name] = file.meta[name]\n      })\n\n      const provider = new Provider(this.uppy, file.remote.providerOptions)\n      provider.post(\n        file.remote.url,\n        Object.assign({}, file.remote.body, {\n          endpoint: opts.endpoint,\n          size: file.data.size,\n          fieldname: opts.fieldName,\n          metadata: fields,\n          headers: opts.headers\n        })\n      )\n      .then((res) => {\n        const token = res.token\n        const host = getSocketHost(file.remote.serverUrl)\n        const socket = new UppySocket({ target: `${host}/api/${token}` })\n\n        socket.on('progress', (progressData) => emitSocketProgress(this, progressData, file))\n\n        socket.on('success', (data) => {\n          const resp = opts.getResponseData(data.response.responseText, data.response)\n          const uploadURL = resp[opts.responseUrlFieldName]\n          this.uppy.emit('upload-success', file, resp, uploadURL)\n          socket.close()\n          return resolve()\n        })\n\n        socket.on('error', (errData) => {\n          const resp = errData.response\n          const error = resp\n            ? opts.getResponseError(resp.responseText, resp)\n            : Object.assign(new Error(errData.error.message), { cause: errData.error })\n          this.uppy.emit('upload-error', file, error)\n          reject(error)\n        })\n      })\n    })\n  }\n\n  uploadBundle (files) {\n    return new Promise((resolve, reject) => {\n      const endpoint = this.opts.endpoint\n      const method = this.opts.method\n\n      const formData = new FormData()\n      files.forEach((file, i) => {\n        const opts = this.getOptions(file)\n        formData.append(opts.fieldName, file.data)\n      })\n\n      const xhr = new XMLHttpRequest()\n\n      xhr.withCredentials = this.opts.withCredentials\n\n      const timer = this.createProgressTimeout(this.opts.timeout, (error) => {\n        xhr.abort()\n        emitError(error)\n        reject(error)\n      })\n\n      const emitError = (error) => {\n        files.forEach((file) => {\n          this.uppy.emit('upload-error', file, error)\n        })\n      }\n\n      xhr.upload.addEventListener('loadstart', (ev) => {\n        this.uppy.log('[XHRUpload] started uploading bundle')\n        timer.progress()\n      })\n\n      xhr.upload.addEventListener('progress', (ev) => {\n        timer.progress()\n\n        if (!ev.lengthComputable) return\n\n        files.forEach((file) => {\n          this.uppy.emit('upload-progress', file, {\n            uploader: this,\n            bytesUploaded: ev.loaded / ev.total * file.size,\n            bytesTotal: file.size\n          })\n        })\n      })\n\n      xhr.addEventListener('load', (ev) => {\n        timer.done()\n\n        if (ev.target.status >= 200 && ev.target.status < 300) {\n          const resp = this.opts.getResponseData(xhr.responseText, xhr)\n          files.forEach((file) => {\n            this.uppy.emit('upload-success', file, resp)\n          })\n          return resolve()\n        }\n\n        const error = this.opts.getResponseError(xhr.responseText, xhr) || new Error('Upload error')\n        error.request = xhr\n        emitError(error)\n        return reject(error)\n      })\n\n      xhr.addEventListener('error', (ev) => {\n        timer.done()\n\n        const error = this.opts.getResponseError(xhr.responseText, xhr) || new Error('Upload error')\n        emitError(error)\n        return reject(error)\n      })\n\n      this.uppy.on('cancel-all', () => {\n        timer.done()\n        xhr.abort()\n      })\n\n      xhr.open(method.toUpperCase(), endpoint, true)\n\n      xhr.withCredentials = this.opts.withCredentials\n\n      Object.keys(this.opts.headers).forEach((header) => {\n        xhr.setRequestHeader(header, this.opts.headers[header])\n      })\n\n      xhr.send(formData)\n\n      files.forEach((file) => {\n        this.uppy.emit('upload-started', file)\n      })\n    })\n  }\n\n  uploadFiles (files) {\n    const actions = files.map((file, i) => {\n      const current = parseInt(i, 10) + 1\n      const total = files.length\n\n      if (file.error) {\n        return () => Promise.reject(new Error(file.error))\n      } else if (file.isRemote) {\n        // We emit upload-started here, so that it's also emitted for files\n        // that have to wait due to the `limit` option.\n        this.uppy.emit('upload-started', file)\n        return this.uploadRemote.bind(this, file, current, total)\n      } else {\n        this.uppy.emit('upload-started', file)\n        return this.upload.bind(this, file, current, total)\n      }\n    })\n\n    const promises = actions.map((action) => {\n      const limitedAction = this.limitUploads(action)\n      return limitedAction()\n    })\n\n    return settle(promises)\n  }\n\n  handleUpload (fileIDs) {\n    if (fileIDs.length === 0) {\n      this.uppy.log('[XHRUpload] No files to upload!')\n      return Promise.resolve()\n    }\n\n    this.uppy.log('[XHRUpload] Uploading...')\n    const files = fileIDs.map((fileID) => this.uppy.getFile(fileID))\n\n    if (this.opts.bundle) {\n      return this.uploadBundle(files)\n    }\n\n    return this.uploadFiles(files).then(() => null)\n  }\n\n  install () {\n    if (this.opts.bundle) {\n      this.uppy.setState({\n        capabilities: Object.assign({}, this.uppy.getState().capabilities, {\n          bundled: true\n        })\n      })\n    }\n\n    this.uppy.addUploader(this.handleUpload)\n  }\n\n  uninstall () {\n    if (this.opts.bundle) {\n      this.uppy.setState({\n        capabilities: Object.assign({}, this.uppy.getState().capabilities, {\n          bundled: true\n        })\n      })\n    }\n\n    this.uppy.removeUploader(this.handleUpload)\n  }\n}\n"]}