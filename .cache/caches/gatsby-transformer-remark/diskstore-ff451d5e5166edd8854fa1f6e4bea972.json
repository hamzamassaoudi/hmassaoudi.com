{"expireTime":9007200833853021000,"key":"transformer-remark-markdown-html-f584a10ca42bd24551448d564c83ce22-gatsby-remark-copy-linked-filesgatsby-remark-imagesgatsby-remark-responsive-iframegatsby-remark-prismjsgatsby-remark-katexgatsby-remark-smartypants-","val":"<p>Anonymization of data became a very trendy topic in recent years. It had been widely adressed by the data community due to its growing importance to all companies collecting personal and sensitive information. </p>\n<p>While structured data is standardized and relatively easy to anonymize, dealing with unstructured data is more tedious. There is no database schema that can be used to measure privacy risk. In this blog, I propose to use a named-entity recognition system (NER) to automatically detect textual confidential attributes such as identifiers, sensitive information, etc. In this case study, I will consider that these confidential information to be detected are disease names in medical diagnoses.</p>\n<h1>Named-Entity Recognition</h1>\n<p>Named-entity recognition (also known as entity identification) seeks to identify and classify words in an unstructured text into pre-defined categories.</p>\n<p>NER is a very challenging learning problem. On the one hand, Supervised training data is very scarce. On the other, this task require language specific knowledge to construct efficient structured features.</p>\n<p> In our example, we are looking to anonymize medic al diagnoses reports by identifying disease names. Thus, our problem is equivalent to a binary classification of names.</p>\n<blockquote>\n<p>Example : <strong>Testicular cancer ** and **endometriosis</strong>  have increased in incidence during the last decades .</p>\n</blockquote>\n<h1>Methodology</h1>\n<p><img src=\"/images/uploads/blog2020/methodo.png\" alt=\"method\"></p>\n<p>As a proof of concept, I will be focusing on locating disease names in medical reports using a model based on conditional random fields. </p>\n<p>In practice, given a sentence, the model will tag each word with a <code class=\"language-text\">&quot;DISEASE&quot;</code>tag if it is a disease name and <code class=\"language-text\">&quot;O&quot;</code> otherwise,  which indicates that a token belongs to no chunk (outside).</p>\n<ol>\n<li>First, we load the labeled data, which is a list of sentences and their corresponding labels</li>\n<li>The second step is the tokenizer, which splits sentences into tokens</li>\n<li>In this step, we use a feature generator to extract reliable features with a window of 3 words (the current word, the previous and the next words)</li>\n<li>The final step uses a CRF to train an NER model.</li>\n</ol>\n<h1>Training Data</h1>\n<p>In our experiments, we took advantage of medical texts that were labeled to study the semantic relationships between diseases and treatments. These <a href=\"https://biotext.berkeley.edu/dis_treat_data.html\">files</a> were obtained from MEDLINE 2001 using the first 100 titles and the first 40 abstracts from the 59 files medline01n*.xml. These data contain 3,654 labeled sentences. The labels are: ”DISONLY”, ”TREATONLY”, ”TREAT PREV”, ”DIS PREV”, ”TREAT SIDE EFF”, ”DIS SIDE EFF”, ”DIS VAG”, ”TREAT VAG”, ”TREAT NO” and”DIS NO”. Because we were only interested in diseases, we only used the 629 sentences with the ”DISONLY” label.</p>\n<p>After formatting and tokenizing raw text data, it looks like this :</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> random\n<span class=\"token keyword\">from</span> spacy<span class=\"token punctuation\">.</span>tokenizer <span class=\"token keyword\">import</span> Tokenizer\n<span class=\"token keyword\">from</span> spacy<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span>en <span class=\"token keyword\">import</span> English\nnlp <span class=\"token operator\">=</span> English<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># Create a blank Tokenizer with just the English vocab</span>\ntokenizer <span class=\"token operator\">=</span> Tokenizer<span class=\"token punctuation\">(</span>nlp<span class=\"token punctuation\">.</span>vocab<span class=\"token punctuation\">)</span>\nfilepath <span class=\"token operator\">=</span> <span class=\"token string\">'data/sentences_with_roles_and_relations.txt'</span>\ndisease_data <span class=\"token operator\">=</span> read_text_labeled_sentences<span class=\"token punctuation\">(</span>filepath<span class=\"token punctuation\">,</span> tokenizer<span class=\"token punctuation\">)</span>\nsample_data_point <span class=\"token operator\">=</span> random<span class=\"token punctuation\">.</span>choice<span class=\"token punctuation\">(</span>disease_data<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Tokens:\\n {}\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>sample_data_point<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Labels:\\n {}\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>sample_data_point<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Out:</p>\n<p><img src=\"/images/uploads/blog2020/input_data.png\" alt=\"method\"></p>\n<p>So basically, disease data is a list of tuples, each tuple (tokens, labels) represent a sentence divided to tokens and corresponding labels. Where 1 stands for disease name and 0 for other than disease name.</p>\n<p>The disease name in the example above  is “Head-neck carcinomas”. Thus, the last 2 labels are both equal to 1.</p>\n<h1>Conditional Random Fields</h1>\n<p>CRFs have seen wide application in many areas, including natural language processing and computer vision. They are often used for structured prediction and tasks that require predicting variables that depend on each other as well as on observed variables.  </p>\n<p>CRFs models combine the ability of graphical models to compactly model the dependence between multivariate data and the ability of classification methods to predict outputs using large sets of input features. </p>\n<p>These models are considered to be the discriminative equivalents of the hidden Markov models. But first, let’s explain what is the difference between generative and discriminative models.</p>\n<h4>Generative and Discriminative Models</h4>\n<p>Generative models’ approach might seem counterintuitive. They describe how a target vector y (in our case : it is the vector representing labels of each word in a sentence) can probabilistically “generate” a feature vector x (words in our case). Discriminative models are more intuitive because they are working backwards, they describe how to assign a label y to a feature vector x.</p>\n<p>In principle, we can see that the approaches are distinct. They work in two opposite directions,  but theoretically, we can always convert between the two methods using Bayes rule.</p>\n<p>For example, in the naive Bayes model, it is easy to convert the joint probability <strong>p(x,y) = p(y)p(x/y)</strong> into a conditional distribution <strong>p(y/x)</strong>. But in practice, we never have the exact true distribution to calculate the conditional distribution. We can end up with two different estimations of p(y/x). </p>\n<p>To sum up, Generative and discriminative may have the same purpose which is calculating the conditional probability p(y/x), but they proceed in two different ways.</p>\n<blockquote>\n<p>The difference between generative models and CRFs is exactly analogous to the difference between the naive Bayes and logistic regression classifiers.</p>\n</blockquote>\n<p>CRFs methods can be seen as the discriminative analog of  generative Hidden Markov models. They can also be understood as a generalization of the logistic regression classifier to arbitrary graphical structures.</p>\n<p>Since our named-entity recognition task rely on predicting a label of each word based on context and not only on word’s features. We will try CRFs methods, we will provide an implementations using <a href=\"https://python-crfsuite.readthedocs.io/en/latest/\">pycrfsuite</a>.</p>\n<h4>Implementation</h4>\n<p>Now that we explained the motivation behind using CRFs model for Named Entity recognition, let’s dive directly into code. We will see how to implement those methods on our dataset.</p>\n<p>First, we begin by calculating features for each word with a window of 3 words, which means that we also include features of next and previous words.</p>\n<p>Here, we calculate features like : word parts, POS tags, word dependencies, lemma, shape (the shape of the word, example: “CRFs” -> “XXXx”), and other boolean variables like : isupper (check if characters are in uppercase), istitle (check if the first character is in uppercase), isdigit (check whether the word consists of digits only), is_stop (check whether the word is a stop word), etc.</p>\n<p>Sklearn-crfsuite supports several input formats; here we use feature lists.</p>\n<p>The code below was adapted from the <a href=\"https://sklearn-crfsuite.readthedocs.io/en/latest/tutorial.html\">official documentation</a></p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> random\n<span class=\"token keyword\">import</span> pycrfsuite\n<span class=\"token keyword\">def</span> <span class=\"token function\">word2features</span><span class=\"token punctuation\">(</span>train_sample<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    token <span class=\"token operator\">=</span> train_sample<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>\n    word <span class=\"token operator\">=</span> token<span class=\"token punctuation\">.</span>text\n    features <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token string\">'bias'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'word.lower='</span> <span class=\"token operator\">+</span> word<span class=\"token punctuation\">.</span>lower<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'word[-3:]='</span> <span class=\"token operator\">+</span> word<span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">3</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'word[-2:]='</span> <span class=\"token operator\">+</span> word<span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">2</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'word.isupper=%s'</span> <span class=\"token operator\">%</span> word<span class=\"token punctuation\">.</span>isupper<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'word.istitle=%s'</span> <span class=\"token operator\">%</span> word<span class=\"token punctuation\">.</span>istitle<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'word.isdigit=%s'</span> <span class=\"token operator\">%</span> word<span class=\"token punctuation\">.</span>isdigit<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'word.pos='</span><span class=\"token operator\">+</span>token<span class=\"token punctuation\">.</span>pos_<span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'word.dep='</span><span class=\"token operator\">+</span>token<span class=\"token punctuation\">.</span>dep_<span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'word.is_stop=%s'</span> <span class=\"token operator\">%</span>token<span class=\"token punctuation\">.</span>is_stop<span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'word.lemma='</span> <span class=\"token operator\">+</span> token<span class=\"token punctuation\">.</span>lemma_<span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'word.tag='</span> <span class=\"token operator\">+</span> token<span class=\"token punctuation\">.</span>tag_<span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'word.shape='</span> <span class=\"token operator\">+</span> token<span class=\"token punctuation\">.</span>shape_<span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'word.is_alpha=%s'</span> <span class=\"token operator\">%</span>token<span class=\"token punctuation\">.</span>is_alpha<span class=\"token punctuation\">,</span>        \n    <span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">if</span> i <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\n        token1 <span class=\"token operator\">=</span> train_sample<span class=\"token punctuation\">[</span>i<span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n        word1 <span class=\"token operator\">=</span> token1<span class=\"token punctuation\">.</span>text\n        features<span class=\"token punctuation\">.</span>extend<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n            <span class=\"token string\">'-1:word.lower='</span> <span class=\"token operator\">+</span> word1<span class=\"token punctuation\">.</span>lower<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'-1:word.istitle=%s'</span> <span class=\"token operator\">%</span> word1<span class=\"token punctuation\">.</span>istitle<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'-1:word.isupper=%s'</span> <span class=\"token operator\">%</span> word1<span class=\"token punctuation\">.</span>isupper<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'-1:word.pos='</span><span class=\"token operator\">+</span>token1<span class=\"token punctuation\">.</span>pos_<span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'-1:word.dep='</span><span class=\"token operator\">+</span>token1<span class=\"token punctuation\">.</span>dep_<span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'-1:word.is_stop=%s'</span> <span class=\"token operator\">%</span>token1<span class=\"token punctuation\">.</span>is_stop<span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'-1:word.lemma='</span> <span class=\"token operator\">+</span> token1<span class=\"token punctuation\">.</span>lemma_<span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'-1:word.tag='</span> <span class=\"token operator\">+</span> token1<span class=\"token punctuation\">.</span>tag_<span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'-1:word.shape='</span> <span class=\"token operator\">+</span> token1<span class=\"token punctuation\">.</span>shape_<span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'-1:word.is_alpha=%s'</span> <span class=\"token operator\">%</span>token1<span class=\"token punctuation\">.</span>is_alpha<span class=\"token punctuation\">,</span>    \n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n        features<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token string\">'BOS'</span><span class=\"token punctuation\">)</span>\n        \n    <span class=\"token keyword\">if</span> i <span class=\"token operator\">&lt;</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>train_sample<span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">:</span>\n        token1 <span class=\"token operator\">=</span> train_sample<span class=\"token punctuation\">[</span>i<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n        word1 <span class=\"token operator\">=</span> token1<span class=\"token punctuation\">.</span>text\n        features<span class=\"token punctuation\">.</span>extend<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n            <span class=\"token string\">'+1:word.lower='</span> <span class=\"token operator\">+</span> word1<span class=\"token punctuation\">.</span>lower<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'+1:word.istitle=%s'</span> <span class=\"token operator\">%</span> word1<span class=\"token punctuation\">.</span>istitle<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'+1:word.isupper=%s'</span> <span class=\"token operator\">%</span> word1<span class=\"token punctuation\">.</span>isupper<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'+1:word.pos='</span><span class=\"token operator\">+</span>token1<span class=\"token punctuation\">.</span>pos_<span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'+1:word.dep='</span><span class=\"token operator\">+</span>token1<span class=\"token punctuation\">.</span>dep_<span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'+1:word.is_stop=%s'</span> <span class=\"token operator\">%</span>token1<span class=\"token punctuation\">.</span>is_stop<span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'+1:word.lemma='</span> <span class=\"token operator\">+</span> token1<span class=\"token punctuation\">.</span>lemma_<span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'+1:word.tag='</span> <span class=\"token operator\">+</span> token1<span class=\"token punctuation\">.</span>tag_<span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'+1:word.shape='</span> <span class=\"token operator\">+</span> token1<span class=\"token punctuation\">.</span>shape_<span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'+1:word.is_alpha=%s'</span> <span class=\"token operator\">%</span>token1<span class=\"token punctuation\">.</span>is_alpha<span class=\"token punctuation\">,</span>   \n        <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n        features<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span><span class=\"token string\">'EOS'</span><span class=\"token punctuation\">)</span>       \n    <span class=\"token keyword\">return</span> features\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">sent2features</span><span class=\"token punctuation\">(</span>train_sample<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>word2features<span class=\"token punctuation\">(</span>train_sample<span class=\"token punctuation\">,</span> i<span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>train_sample<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">encode_labels</span><span class=\"token punctuation\">(</span>labels<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"DISEASE\"</span> <span class=\"token keyword\">if</span> label<span class=\"token operator\">==</span><span class=\"token number\">1</span> <span class=\"token keyword\">else</span> <span class=\"token string\">\"O\"</span> <span class=\"token keyword\">for</span> label <span class=\"token keyword\">in</span> labels<span class=\"token punctuation\">]</span></code></pre></div>\n<p>We use the encode_labels function to encode integer labels (0 or 1) to string labels (“DISEASE” or “O”) to respect the target format needed by Sklearn-crfsuite.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">random<span class=\"token punctuation\">.</span>shuffle<span class=\"token punctuation\">(</span>disease_data<span class=\"token punctuation\">)</span>\ntraining_data <span class=\"token operator\">=</span> disease_data<span class=\"token punctuation\">[</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.3</span><span class=\"token operator\">*</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>disease_data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span>\ntest_data <span class=\"token operator\">=</span> disease_data<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.3</span><span class=\"token operator\">*</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>disease_data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n<span class=\"token comment\">#%%</span>\nX_train <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>sent2features<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> s <span class=\"token keyword\">in</span> training_data<span class=\"token punctuation\">]</span>\ny_train <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>encode_labels<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> s <span class=\"token keyword\">in</span> training_data<span class=\"token punctuation\">]</span>\n\nX_test <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>sent2features<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> s <span class=\"token keyword\">in</span> test_data<span class=\"token punctuation\">]</span>\ny_test <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>s<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">for</span> s <span class=\"token keyword\">in</span> test_data<span class=\"token punctuation\">]</span></code></pre></div>\n<p>Once we defined the training and the test sets, we can begin training the model</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">trainer <span class=\"token operator\">=</span> pycrfsuite<span class=\"token punctuation\">.</span>Trainer<span class=\"token punctuation\">(</span>verbose<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">for</span> xseq<span class=\"token punctuation\">,</span> yseq <span class=\"token keyword\">in</span> <span class=\"token builtin\">zip</span><span class=\"token punctuation\">(</span>X_train<span class=\"token punctuation\">,</span> y_train<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    trainer<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>xseq<span class=\"token punctuation\">,</span> yseq<span class=\"token punctuation\">)</span>\n\ntrainer<span class=\"token punctuation\">.</span>set_params<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token string\">'c1'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0.44</span><span class=\"token punctuation\">,</span>   <span class=\"token comment\"># coefficient for L1 penalty</span>\n    <span class=\"token string\">'c2'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1e</span><span class=\"token operator\">-</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># coefficient for L2 penalty</span>\n    <span class=\"token string\">'max_iterations'</span><span class=\"token punctuation\">:</span> <span class=\"token number\">60</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># stop earlier</span>\n\n    <span class=\"token comment\"># include transitions that are possible, but not observed</span>\n    <span class=\"token string\">'feature.possible_transitions'</span><span class=\"token punctuation\">:</span> <span class=\"token boolean\">True</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Model's parameters : {}\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>trainer<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\ntrainer<span class=\"token punctuation\">.</span>train<span class=\"token punctuation\">(</span><span class=\"token string\">'models/crf_model.crfsuite'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Last iteration log {}\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>trainer<span class=\"token punctuation\">.</span>logparser<span class=\"token punctuation\">.</span>last_iteration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Out:</p>\n<p><img src=\"/images/uploads/blog2020/CRF_log.png\" alt=\"log\"></p>\n<p>We begin by defining a trainer which is mainly our CRFs model, we then define some parameters like c1 and c2 (Coefficients used for regularization) and the max_iteration parameter (used to stop model’s iterations). After training, the model is automatically stored in the directory specified in the train function.</p>\n<h1>Results and conclusion</h1>\n<p>After training the model let’s see how to calculate the labels for a given test example:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">tagger <span class=\"token operator\">=</span> pycrfsuite<span class=\"token punctuation\">.</span>Tagger<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\ntagger<span class=\"token punctuation\">.</span><span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"models/crf_model.crfsuite\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"sentence: {}\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>test_data<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"predicted labels: {}\"</span><span class=\"token punctuation\">.</span> <span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>tagger<span class=\"token punctuation\">.</span>tag<span class=\"token punctuation\">(</span>X_test<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"real labels {}\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>encode_labels<span class=\"token punctuation\">(</span>y_test<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Out:</p>\n<p><img src=\"/images/uploads/blog2020/output.png\" alt=\"output\"></p>\n<p>As we can see, the model predict it right this time, but it may surely miss some disease names. Let’s measure the overall performance.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">outputs <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>X_test<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    outputs<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>tagger<span class=\"token punctuation\">.</span>tag<span class=\"token punctuation\">(</span>X_test<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\ntargets <span class=\"token operator\">=</span> <span class=\"token builtin\">sum</span><span class=\"token punctuation\">(</span>y_test<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\noutputs <span class=\"token operator\">=</span> <span class=\"token builtin\">sum</span><span class=\"token punctuation\">(</span>outputs<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\noutputs <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span> <span class=\"token keyword\">if</span> output<span class=\"token operator\">==</span><span class=\"token string\">\"O\"</span> <span class=\"token keyword\">else</span> <span class=\"token number\">1</span> <span class=\"token keyword\">for</span> output <span class=\"token keyword\">in</span> outputs<span class=\"token punctuation\">]</span>\n\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"conf_matrix: \\n\"</span><span class=\"token punctuation\">,</span> confusion_matrix<span class=\"token punctuation\">(</span>targets<span class=\"token punctuation\">,</span> outputs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"precision score:\\n\"</span><span class=\"token punctuation\">,</span> precision_score<span class=\"token punctuation\">(</span>targets<span class=\"token punctuation\">,</span> outputs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"recall score:\\n\"</span><span class=\"token punctuation\">,</span> recall_score<span class=\"token punctuation\">(</span>targets<span class=\"token punctuation\">,</span> outputs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"F1 score:\\n\"</span><span class=\"token punctuation\">,</span> f1_score<span class=\"token punctuation\">(</span>targets<span class=\"token punctuation\">,</span> outputs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Out:</p>\n<p><img src=\"/images/uploads/blog2020/measure.png\" alt=\"measure\"></p>\n<p>We can see that the precision is much better than recall, which means that the number of false positives (Other names that are detected as disease names) is not that high. Still, there is a lot of disease names that are indetectable by the model. It might be explained by the size of training dataset.</p>\n<p>It is worth mentioning that this model is very sensitive to features choice. I recommend the reader to delete or add features of his choice to test the model.</p>\n<p>It is true that CRFs are well suited to named-entity recognition task, but other deep learning models have shown a better performance. </p>\n<p>RNNs architectures are known to be able to capture the dependence between input variables. LSTM deep learning models can be a good alternative to try. Some recent works also include  contextual embedding of words using attention. </p>"}